#+title:  開発ノート
#+author: kenjirofukuda@gmail.com
#+date: 2024-01-02

* 回転変換の修正 

変換が意図した挙動を示さないため、BGRATransform の AffineMatrixRotationRadを調べてみたら
-1 をかける位置が意図したものと異なっていいたのでハードコードした。

#+begin_src opascal
  function AffineMatrixRotationRad(AngleCCW: single): TAffineMatrix;
  begin
    Result := AffineMatrix(cos(AngleCCW), sin(AngleCCW), 0,
                          -sin(AngleCCW), cos(AngleCCW), 0);
  end;

#+end_src


#+begin_src opascal
  Result := AffineMatrix(cos(AngleCCW), -sin(AngleCCW), 0,
                         sin(AngleCCW),  cos(AngleCCW), 0);
#+end_src


* キーナビゲーション
GNUstep バージョンでは以下の割当を行い、なんの問題もなく実現している。
NSView 配下なら NSResponder 配下なのでイベントにフックをかけるのは造作もない。
+-------+-----------------+
| 右矢印 | View Move Right |
+-------+-----------------+
| 左矢印 | View Mode Left  |
+-------+-----------------+
| 上矢印 | View Move Up    |
+-------+-----------------+
| 下矢印 | View Move Down  |
+-------+-----------------+
| Home  | Fit             |
+-------+-----------------+
| +     | Zoom 2.0        |
+-------+-----------------+
| -     | Zoom 0.5        |
+-------------------------+
ところが Lazarus でキーイベントを拾えるのかを調べてみたらかなりのハードルのようである。

** TPaintBox 上で、キーエベントを取得
解決のヒントになると思われるサイトが以下である。
https://www.petitmonte.com/bbs/answers?question_id=1503

* 描画時間の削減
一番巨大なBandgap の描画に時間がかかりすぎている。
GNUstep 版は 280 ms から 300 ms である。

| 初回測定                | 800 ms         |
| 描画周りのDebugLn 削除   | 400 ms         |
| PenのSave Restore 廃止 | 227 から 240 ms |

やっと、GNUstep 版を追い越した。

